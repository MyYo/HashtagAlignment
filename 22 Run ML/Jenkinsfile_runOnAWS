//This Jenkinsfile will reslice
pipeline {
	agent any
	environment {
    	CREDENTIALS_PATH = "..\\..\\"
	}
	options {
		buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30')) //Discard old builds
  	}
	parameters 
	{
		string(
			name: "ML_GIT_PATH",
			defaultValue:"https://github.com/NVIDIA/pix2pixHD",
			description:"Git path to the machine learning model to use",
			trim: true)
		string(
			name: "MATLAB_PARAMETERS",
			defaultValue:"",
			description:"Additional Matlab parameters to set, read documentation of scriptSetupML for what parameters are possible\nExample: patchPixelSize_=2; patchSizeX_pix_=20;",
			trim: true)
		string(
			name: "WHO_TO_EMAIL_WHEN_DONE",
			defaultValue:"",
			description:"Who should get an email with the results?  (Apart from you! - you will get an email anyways)\n\nUse comma to specify multiple emails\nExample: me@stanford.edu, you@stanford.edu",
			trim: true)
    }
	stages{
		stage("Checkout")
		{steps{script{
			//Figure out which branch Jenkinsfile was checked out, we will checkout the same one
			def gitTxt
			try
			{
				bat "git describe --tags --exact-match > commandResult.txt" 
				gitTxt = readFile('commandResult.txt').trim()
				echo gitTxt
				if (gitTxt.contains("fatal: No tags can describe"))
				{
					gitTxt = "master"
				}
			}
			catch(Exception e)
			{ 
				// Couldn't find exact match, its actually we look at the master
				gitTxt = "master"
			}
			
			branch = gitTxt
			echo("Jenkins Build #: " + env.BUILD_NUMBER)
			echo("Fetching: " + branch)
			
			//Identify where github is installed
			def gitFolderOption1 = new File("C:\\Program Files (x86)\\Git\\cmd\\")
			def gitFolderOption2 = new File("C:\\Program Files\\Git\\cmd\\")
			def gitFolder = ""
			if (gitFolderOption1.exists()) {
				gitFolder = gitFolderOption1.absolutePath
			} else if (gitFolderOption2.exists()) {
				gitFolder = gitFolderOption2.absolutePath
			} else {
				error "Clould not find git in the known possible possitions"
			}
			gitFolder = gitFolder + "\\"
			
			//Checkout a fresh copy 
			cleanWs()
			bat('"' + gitFolder + 'git.exe" clone --branch "' + branch + '" --single-branch "https://github.com/MyYo/HashtagAlignment.git"') //Checkout HashtagAlignment
			bat('"' + gitFolder + 'git.exe" clone --branch "' + branch + '" --single-branch "https://github.com/MyYo/myOCT.git"') //Checkout myOCT
			
			//Make note of the repository version
			bat('@cd HashtagAlignment && @"' + gitFolder + 'git.exe" rev-parse HEAD > ..\\commandResult.txt')
			def hashtagAlignmentVer = readFile('commandResult.txt').trim()
			bat('@cd myOCT && @"' + gitFolder + 'git.exe" rev-parse HEAD > ..\\commandResult.txt')
			def myOCTVer = readFile('commandResult.txt').trim()
			
			//Move files to main folder
			bat('@xcopy /E HashtagAlignment . /Y /Q')
			bat('@xcopy /E myOCT . /Y /Q')
			bat('@copy "%CREDENTIALS_PATH%\\*.m" .')
			
			//Delete folder used for checkout
			bat('@rmdir HashtagAlignment /S /Q')
			bat('@rmdir myOCT /S /Q')
			
			//Start buidling the runme file
			bat("@echo disp('HashtagAlignment Git Hash: " + hashtagAlignmentVer + "');  >> runme.m")
			bat("@echo disp('myOCT Git Hash: " + myOCTVer + "');  >> runme.m")
			bat("@echo disp('To see repository go to');  >> runme.m")
			bat("@echo disp('https://github.com/MyYo/HashtagAlignment/tree/" + hashtagAlignmentVer + "'); >> runme.m")
			bat("@echo disp('https://github.com/MyYo/myOCT/tree/"            + myOCTVer + "'); >> runme.m")
			bat("@echo HashtagAlignmentGitHash = '" + hashtagAlignmentVer + "';  >> runme.m")
			bat("@echo myOCTGitHash = '" + myOCTVer + "';  >> runme.m")
			
			echo("Checking out $ML_GIT_PATH")
			bat('"' + gitFolder + 'git.exe" clone --single-branch "%ML_GIT_PATH%" ./Testers/sc/') //Checkout myOCT
			bat("@echo folderToUpload_AdditionalCodeAndData_ = 'sc\';  >> runme.m")
			
		}}}
		stage("Build Runme File and Run Matlab")
		{steps{script{
			bat("@echo scriptSetupML; >> runme.m")
			
			// Before starting matlab, make sure instructions.txt exists and contain some information
			bat("@echo No Instructions > Testers/instructions.txt")
			nextCommands = readFile('Testers/instructions.txt').trim() //DELETE HERE
			echo(nextCommands) //DELETE HERE
			echo("here") //DELETE HERE
			echo(pwd())
			
			try
			{
				RunMatlabRunme(false)
				currentBuild.result = 'SUCCESS'
			}
			catch(Exception e)
			{
				currentBuild.result = 'FAILURE'
				throw("Matlab Failed")
			}
			finally
			{
				echo("Check point #1") //DELETE HERE
				echo(pwd())
				//EMAIL
				//Get the email of the user who started the build
				def userId = currentBuild.getRawBuild().getCauses()[0].getUserId()
				hudson.model.User user = hudson.model.User.get(userId)
				email = user.getProperty(hudson.tasks.Mailer.UserProperty).getAddress()
				echo("Check point #2") //DELETE HERE
				// Get the result from matlab if exists
				bat("copy Testers\\instructions.txt instructions.txt")
				bat("type instructions.txt")
				nextCommands = readFile('instructions.txt').trim()
				echo("Check point #3") //DELETE HERE
				echo("Check point #3" + nextCommands) //DELETE HERE
				try
				{
				echo("Check point #4")
				echo("Check point #4" + nextCommands)
				emailext ( //Using ext-email plugin
					subject: "[OCTHist] ML Started ${currentBuild.result} #$BUILD_NUMBER",
					from : "Yonatan",
					body: 
					"Hi,<br>" +
					"Your AWS has started, ML model is active.<br> Instructions: Run matlab commands:<br><br>"+
					nextCommands 
					,
					attachLog: true,
					to: "$WHO_TO_EMAIL_WHEN_DONE," + email )
				}
				catch(Exception e)
				{
					echo "Might had a problem with sending the email out"
				}
				
			}
		}}}
	}
}
def RunMatlabRunme(isConnectToCluster=false)  //runs runme.m
{
	try
	{
		def rootDir = pwd()
		def MatlabRunner = load "${rootDir}/98 Jenkins Lib/MatlabRunner.Groovy"
		MatlabRunner.RunMatlabScript ("runme.m",isConnectToCluster);
		bat("@del \f runme.m");
	}
	catch(Exception e)
	{
		currentBuild.result = 'FAILURE'
		throw("Matlab Failed")
	}
}