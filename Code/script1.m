%This script runs Hashtag Alignment

%% Inputs

%Histology 
histologyFluorescenceFP = '\\171.65.17.174\MATLAB_Share\Itamar\2018_06_13_14-59-16\Experiment.lif_Image018_ch01.tif';
histologyFluorescenceIm = fliplr(flipud(double(imread(histologyFluorescenceFP))));
histologyFluorescenceSize = 1.2e-6; %[mm]
histologyImageFP = '\\171.65.17.174\MATLAB_Share\Itamar\2018_06_13_14-59-16\Experiment.lif_Image018_ch00.tif';
histologyImage = fliplr(flipud(double(imread(histologyImageFP))));

%# Alignment Markers Specifications
%                1    2    3    4    5
lnDist = 1e-6*[-50  +50  -50    0  +50]; %Line distance from origin [m]
lnDir  =      [  0    0    1    1    1]; %Line direction 0 - left right, 1 - up down
lnNames=     { '-x' '+x' '-y' '0y' '+y'}; %Line names

%OCT
OCTVolumeFolder = '\\171.65.17.174\MATLAB_Share\Itamar\2018_06_13_14-59-16\';
OCTVolumePosition = [-1e-3 +1e-3     0; ... %x,y,z position [m] of the first A scan in the first B scan (1,1)
                     -1e-3 +1e-3  2e-3]';     %x,y,z position [m] of the las A scan in the last B scan (end,end). z is deeper!
dispersionParameterA = 2.271e-02;  %Use this dispersion Parameter for air-water interface - Wasatch

%Plotting
%plot after step #     1     2     3
isPlotStepResults = [ false true false];

%Enter your own points (optional). Comment out if not in use
ptsPixPosition = [4.390286e+02,258;4.389591e+02,259;4.388430e+02,260;4.387651e+02,261;4.387117e+02,262;4.386815e+02,263;4.387289e+02,264;4.387313e+02,265;4.387186e+02,266;4.387018e+02,267;4.386068e+02,268;4.385824e+02,269;4.385788e+02,270;4.384705e+02,271;4.384220e+02,272;4.384463e+02,273;4.382115e+02,274;4.381657e+02,275;4.381156e+02,276;4.379721e+02,277;4.378869e+02,278;4.378620e+02,279;4.377498e+02,280;4.377338e+02,281;4.378094e+02,282;4.376815e+02,283;4.376274e+02,284;4.378039e+02,285;4.376105e+02,286;4.377451e+02,287;4.377192e+02,288;4.376094e+02,289;4.374891e+02,290;4.372632e+02,291;4.371582e+02,292;4.372032e+02,293;4.374129e+02,294;4.373290e+02,295;4.371186e+02,296;4.371856e+02,297;4.369467e+02,298;4.371211e+02,299;4.372705e+02,300;4.373585e+02,301;4.374973e+02,302;4.374745e+02,303;4.373565e+02,304;4.371879e+02,305;4.372466e+02,306;4.372867e+02,307;4.370689e+02,308;4.372757e+02,309;4.371384e+02,310;4.369761e+02,311;4.368699e+02,312;4.369441e+02,313;4.369050e+02,314;4.369267e+02,315;4.368741e+02,316;4.367236e+02,317;4.367771e+02,318;4.366827e+02,319;4.361917e+02,320;4.361419e+02,321;4.360122e+02,322;4.359843e+02,323;4.357965e+02,324;4.360117e+02,325;4.357905e+02,326;4.359777e+02,327;4.360008e+02,328;4.362232e+02,329;4.367701e+02,330;4.362238e+02,331;4.362631e+02,332;4.370917e+02,333;4.362892e+02,334;4.362046e+02,335;4.359480e+02,336;4.361919e+02,337;4.361966e+02,338;4.361010e+02,339;4.358676e+02,340;4.357509e+02,341;4.358838e+02,342;4.358301e+02,343;4.354334e+02,344;4.357715e+02,345;4.356284e+02,346;4.355099e+02,347;4.355109e+02,348;4.355062e+02,349;4.358236e+02,350;4.361113e+02,351;4.363627e+02,352;4.363938e+02,353;4.365134e+02,354;4.365283e+02,355;4.364675e+02,356;4.363766e+02,357;4.366323e+02,358;3.822959e+02,254;3.822340e+02,255;3.822439e+02,256;3.821986e+02,257;3.820777e+02,258;3.820131e+02,259;3.820428e+02,260;3.820246e+02,261;3.820294e+02,262;3.820061e+02,263;3.820296e+02,264;3.819601e+02,265;3.819553e+02,266;3.818961e+02,267;3.817969e+02,268;3.817883e+02,269;3.817283e+02,270;3.815943e+02,271;3.813706e+02,272;3.812535e+02,273;3.811231e+02,274;3.809297e+02,275;3.807734e+02,276;3.805762e+02,277;3.805299e+02,278;3.804214e+02,279;3.803347e+02,280;3.802610e+02,281;3.801922e+02,282;3.801463e+02,283;3.800428e+02,284;3.799953e+02,285;3.799777e+02,286;3.799783e+02,287;3.799648e+02,288;3.798758e+02,289;3.799052e+02,290;3.798608e+02,291;3.798540e+02,292;3.799054e+02,293;3.799155e+02,294;3.799897e+02,295;3.801609e+02,296;3.802081e+02,297;3.802712e+02,298;3.801939e+02,299;3.803198e+02,300;3.803546e+02,301;3.804217e+02,302;3.805592e+02,303;3.806243e+02,304;3.807045e+02,305;3.807373e+02,306;3.807102e+02,307;3.807838e+02,308;3.807691e+02,309;3.808644e+02,310;3.809068e+02,311;3.810058e+02,312;3.811410e+02,313;3.811413e+02,314;3.811060e+02,315;3.811390e+02,316;3.811959e+02,317;3.812663e+02,318;3.813336e+02,319;3.812414e+02,320;3.812921e+02,321;3.812496e+02,322;3.812123e+02,323;3.810884e+02,324;3.809082e+02,325;3.809672e+02,326;3.810482e+02,327;3.809738e+02,328;3.810867e+02,329;3.809366e+02,330;3.810208e+02,331;3.810960e+02,332;3.810489e+02,333;3.812047e+02,334;3.813176e+02,335;3.814754e+02,336;3.814733e+02,337;3.815873e+02,338;3.817539e+02,339;3.813398e+02,340;3.813820e+02,341;3.814997e+02,342;3.812929e+02,343;3.812475e+02,344;3.812681e+02,345;3.810326e+02,346;3.808573e+02,347;3.806551e+02,348;1.551478e+02,243;1.552537e+02,244;1.552941e+02,245;1.553344e+02,246;1.554673e+02,247;1.555923e+02,248;1.556678e+02,249;1.557115e+02,250;1.557328e+02,251;1.558312e+02,252;1.559062e+02,253;1.559641e+02,254;1.560085e+02,255;1.561245e+02,256;1.562716e+02,257;1.562518e+02,258;1.563716e+02,259;1.564492e+02,260;1.565098e+02,261;1.565686e+02,262;1.566828e+02,263;1.568080e+02,264;1.568973e+02,265;1.569417e+02,266;1.570273e+02,267;1.571385e+02,268;1.572568e+02,269;1.573052e+02,270;1.573841e+02,271;1.574936e+02,272;1.576507e+02,273;1.576923e+02,274;1.577323e+02,275;1.577731e+02,276;1.578814e+02,277;1.579911e+02,278;1.581270e+02,279;1.582262e+02,280;1.583338e+02,281;1.583547e+02,282;1.584334e+02,283;1.583733e+02,284;1.584671e+02,285;1.585415e+02,286;1.587729e+02,287;1.587464e+02,288;1.586974e+02,289;1.587269e+02,290;1.588755e+02,291;1.590236e+02,292;1.591220e+02,293;1.593175e+02,294;1.594425e+02,295;1.596447e+02,296;1.596139e+02,297;1.595093e+02,298;1.595816e+02,299;1.597210e+02,300;1.599353e+02,301;1.601952e+02,302;1.601450e+02,303;1.602017e+02,304;1.602754e+02,305;1.603989e+02,306;1.603313e+02,307;1.604965e+02,308;1.604385e+02,309;1.605488e+02,310;1.609347e+02,311;1.610049e+02,312;1.610730e+02,313;1.612337e+02,314;1.612883e+02,315;1.613298e+02,316;1.612935e+02,317;1.614471e+02,318;1.615456e+02,319;1.616736e+02,320;1.617291e+02,321;1.617407e+02,322;1.620454e+02,323;1.620485e+02,324;1.621177e+02,325;1.622034e+02,326;1.623097e+02,327;1.624442e+02,328;1.626114e+02,329;1.624618e+02,330;1.625017e+02,331;1.627145e+02,332;1.273314e+02,241;1.274024e+02,242;1.274332e+02,243;1.274499e+02,244;1.274903e+02,245;1.275347e+02,246;1.275996e+02,247;1.276880e+02,248;1.277417e+02,249;1.278146e+02,250;1.279577e+02,251;1.279999e+02,252;1.280613e+02,253;1.281453e+02,254;1.282458e+02,255;1.282584e+02,256;1.283763e+02,257;1.283843e+02,258;1.284620e+02,259;1.285649e+02,260;1.286971e+02,261;1.287833e+02,262;1.290087e+02,263;1.291581e+02,264;1.292407e+02,265;1.293146e+02,266;1.294417e+02,267;1.294639e+02,268;1.296024e+02,269;1.296526e+02,270;1.296607e+02,271;1.296473e+02,272;1.297085e+02,273;1.298007e+02,274;1.297761e+02,275;1.298543e+02,276;1.299205e+02,277;1.300574e+02,278;1.301724e+02,279;1.303390e+02,280;1.303395e+02,281;1.304811e+02,282;1.305456e+02,283;1.306090e+02,284;1.308816e+02,285;1.310349e+02,286;1.311259e+02,287;1.311490e+02,288;1.312301e+02,289;1.312795e+02,290;1.311562e+02,291;1.313064e+02,292;1.313807e+02,293;1.316517e+02,294;1.317280e+02,295;1.315516e+02,296;1.316946e+02,297;1.317578e+02,298;1.318526e+02,299;1.320117e+02,300;1.318773e+02,301;1.319288e+02,302;1.319464e+02,303;1.319298e+02,304;1.319707e+02,305;1.318767e+02,306;1.321401e+02,307;1.324214e+02,308;1.322827e+02,309;1.325260e+02,310;1.322862e+02,311;1.325526e+02,312;1.326247e+02,313;1.328844e+02,314;1.328486e+02,315;1.328219e+02,316;1.329098e+02,317;1.329580e+02,318;1.328921e+02,319;1.330039e+02,320;1.331057e+02,321;1.330523e+02,322;1.332212e+02,323;1.332635e+02,324;1.331316e+02,325;1.329867e+02,326;1.333838e+02,327;9.492011e+01,240;9.502058e+01,241;9.481129e+01,242;9.677201e+01,243;9.660766e+01,244;9.653384e+01,245;9.641705e+01,246;9.603985e+01,247;9.557069e+01,248;9.539495e+01,249;9.546916e+01,250;9.544025e+01,251;9.526533e+01,252;9.522068e+01,253;9.493760e+01,254;9.773412e+01,255;9.755160e+01,256;9.740140e+01,257;9.763526e+01,258;9.753338e+01,259;9.771591e+01,260;9.796652e+01,261;9.795667e+01,262;9.785291e+01,263;9.790584e+01,264;9.759935e+01,265;9.763854e+01,266;9.780662e+01,267;9.953236e+01,268;9.953915e+01,269;9.957301e+01,270;9.954900e+01,271;9.961020e+01,272;9.971873e+01,273;9.974227e+01,274;9.966117e+01,275;9.988383e+01,276;9.985947e+01,277;9.976255e+01,278;9.981995e+01,279;1.010516e+02,280;1.009390e+02,281;1.012725e+02,282;1.013854e+02,283;1.014344e+02,284;1.013740e+02,285;1.013138e+02,286;1.013531e+02,287;1.012386e+02,288;1.012002e+02,289;1.012413e+02,290;1.015180e+02,291;1.024193e+02,292;1.023075e+02,293;1.024145e+02,294;1.024605e+02,295;1.026294e+02,296;1.028688e+02,297;1.031077e+02,298;1.032472e+02,299;1.032904e+02,300;1.034256e+02,301;1.035530e+02,302;1.034870e+02,303;1.037896e+02,304;1.036935e+02,305;1.039418e+02,306;1.040587e+02,307;1.042118e+02,308;1.040478e+02,309;1.040786e+02,310;1.042827e+02,311;1.041962e+02,312;1.043501e+02,313;1.044805e+02,314;1.049586e+02,315;1.049052e+02,316;1.050115e+02,317;1.049395e+02,318;1.049053e+02,319;1.050487e+02,320;1.053859e+02,321;1.052615e+02,322;1.052631e+02,323;1.050330e+02,324;1.051681e+02,325;1.051300e+02,326]; %(pixX,pixY)
ptsId = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5];
                  
%% Step #1: Find Feducial Marker in Fluorescence Image: ptsPixPosition, ptsId
if (~exist('ptsPixPosition','var'))
    %TBD, merge with Itamar
    [ptsPixPosition, ptsId] = findLines (histologyFluorescenceIm,histologyFluorescenceSize,lnNames);
    
    %Output points, in case we would want to use them
    s1 = sprintf('%.2f,%.2f;',ptsPixPosition');
    s2 = sprintf('%d,',ptsId);
    fprintf('ptsPixPosition = [%s]; %%(pixX,pixY)\n',s1(1:(end-1)));
    fprintf('ptsId = [%s];\n',s2(1:(end-1)));
end

%% Step #2: Find Plane Parameters: u,v,h

%Find position and direction by line identity
ptsLnDist = lnDist(ptsId); ptsLnDist = ptsLnDist(:);
ptsLnDir  = lnDir(ptsId);  ptsLnDir  = ptsLnDir(:);

%Compute plane parameters
[u,v,h] = identifiedPointsToUVH (ptsPixPosition,ptsLnDist, ptsLnDir);

%Find intercepts
%   h+U*u+V*v=(?;0).
%   U=-(h(2)+V*v(2))/u(1)
V = mean(ptsPixPosition(:,2)); %Take average image height
UX=-(h(2)+V*v(2))/u(2);
X=u(1)*UX+v(2)*V+h(1);
UY=-(h(1)+V*v(1))/u(1);
Y=u(2)*UY+v(2)*V+h(2);

if isPlotStepResults(2)
    
    fprintf('Pixel Size: |u|=%.3f[microns], |v|=%.3f[microns]\n',norm(u)*1e6,norm(v)*1e6)
    fprintf('Angle In X-Y Plane: %.2f[deg], Tilt: %.2f[deg]\n',atan2(u(2),u(1))*180/pi,acos(dot(v/norm(v),[0;0;1]))*180/pi);
    fprintf('Intercept Points. x=%.3f[mm],y=%.3f[mm]\n',1e3*X,1e3*Y);

    %Plot
    figure(2);
    
    %Main Figure
    imagesc(histologyFluorescenceIm);
    hold on;
    
    %Plot points found on figure
    ltxt = 'legend(';
    for i=1:length(lnNames)
        %Plot all the idetified points used in calculation
        if (sum(ptsId==i)>0) %Are there any points in that line
            ltxt = sprintf('%s''%s'',',ltxt,lnNames{i});
            plot(ptsPixPosition(ptsId==i,1),ptsPixPosition(ptsId==i,2),'.');
        end
    end
    ltxt = sprintf('%s''location'',''south'');',ltxt);
    
    %Plot Intercepts
    sx = size(histologyFluorescenceIm,2);
    sz = size(histologyFluorescenceIm,1);
    plot(UX*[1 1],[1 sx],'--r',UY*[1 1],[1 sx],'--r');
    text(UX,sz/4,sprintf('X Intercept\n%.3f[mm]',X*1e3),'Color','red')
    text(UY,sz/4,sprintf('Y Intercept\n%.3f[mm]',Y*1e3),'Color','red')
    
    hold off;
    colormap gray;
    eval(ltxt);
    title('Step #2: Plane Paramaters');
    pause(0.01);
    
end

%% Step #3: Reslice OCT Volume to Find B-Scan That Fits Histology
if ~exist(OCTVolumeFolder,'dir')
    return; %No OCT to Slice, we are done
end

%Load OCT Processed Volume
scanAbsFP = [OCTVolumeFolder '\scanAbs.tif'];
tic;
if ~exist(scanAbsFP,'file')
    %Need to Process Volume
    
    %Load OCT
    meanAbs = yOCTProcessScan(OCTVolumeFolder, 'meanAbs', ...
        'OCTSystem', 'Wasatch', ...
        'dispersionParameterA', dispersionParameterA);
    
    yOCT2Tif(log(meanAbs),scanAbsFP);
end
toc;
meanAbs = yOCTFromTif(scanAbsFP);

%%    

%Reslice
rOCT = resliceOCTVolume( ...
    u,v,h,size(histologyImage), ...
    OCTVolumeFolder,OCTVolumePosition,'Wasatch',dispersionParameterA ...
    );

%% Plot
figure(3);
imagesc(log(rOCT));
colormap gray;
title('OCT Slice');
pause(0.01);

return;
%% This code is experimental, may be removed in the future.
%Load Intef From file
[interf,dimensions] = yOCTLoadInterfFromFile(OCTVolumeFolder,'OCTSystem','Wasatch');

%Generate BScans
scanCpx = yOCTInterfToScanCpx(interf,dimensions ...
    ,'dispersionParameterA', dispersionParameterA ...Use this dispersion Parameter for air-water interface
    );

%Average B Scan Averages
scanAbs = mean(abs(scanCpx),4);

%Re-arange dimensions such that scanAbs is (x,y,z)
scanAbs = shiftdim(scanAbs,1);

%Reslice
rOCT = resliceOCTVolume(scanAbs, OCTVolumePosition,u,v,h,size(histologyImage));

%TBD find h(z)

%TBD plot


